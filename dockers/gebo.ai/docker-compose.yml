version: "3.1"
#================================================================
# This compose file creates a service for gebo.ai enterprise retrive augmented generation system
# and its required mongodb (database) and qdrant (vector database) services
# once runned simply open the address http://<your host address:12999/ with your browser
# it will be required to create the administrative account and you'll be ready to setup and
# start immediately to share the application with your company or team.
services:
  # =======================
  # MongoDB
  # =======================
  # Bound only on loopback interface for security reasons
  mongo:
    image: mongo
    restart: always
    ports:
      - "127.0.0.1:27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongoroot
      MONGO_INITDB_ROOT_PASSWORD: mongopwd
    command: ["mongod", "--wiredTigerCacheSizeGB=1"]
    volumes:
      # Bind mount a local directory instead of named volume
      - /home/gebo.ai/mongo:/data/db

  # =======================
  # Qdrant
  # =======================
  # Bound only on loopback interface for security reasons
  qdrant:
    image: qdrant/qdrant
    restart: always
    ports:
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    environment:
      QDRANT__SERVICE__API_KEY: ce7c85bc-f037-4c64-91d8-70335638329d
      QDRANT__STORAGE__OPTIMIZE_INDEXING: "true"
      QDRANT__STORAGE__RAM_DISK_SIZE: "256MB"
      QDRANT__STORAGE__MAX_SEGMENT_SIZE: "1000000"
    volumes:
      # Bind mount a local directory
      - /home/gebo.ai/qdrant:/qdrant/storage
  neo4j:
    image: neo4j:5
    restart: always
    # Expose HTTP (7474) and Bolt (7687) on loopback for local access
    ports:
      - "127.0.0.1:7474:7474"
      - "127.0.0.1:7687:7687"
    environment:
      # Auth: username/password
      NEO4J_AUTH: "neo4j/neo4jmaster"
      # Optional tuning (comment out if not needed)
      NEO4J_server_memory_heap_initial__size: 1G
      NEO4J_server_memory_heap_max__size: 2G
      NEO4J_server_memory_pagecache_size: 512M
      # Allow APOC when you add the plugin in /plugins
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
    volumes:
      - /home/gebo.ai/neo4j/data:/data
      - /home/gebo.ai/neo4j/logs:/logs
      - /home/gebo.ai/neo4j/plugins:/plugins
      - /home/gebo.ai/neo4j/import:/import

  # =======================
  # gebo.ai
  # =======================
  # Bound to all host interface
  gebo.ai:
    image: geboai/gebo.ai
    restart: always
    ports:
      - "12999:12999"
    depends_on:
      - mongo
      - qdrant
      - neo4j
    volumes:
      # Bind mount two local directories for work and home
      - /home/gebo.ai/work:/opt/gebo.ai/work
      - /home/gebo.ai/home:/opt/gebo.ai/home
      - /home/gebo.ai/logs:/opt/gebo.ai/logs
      - /mnt:/opt/gebo.ai/shares
    deploy:
      resources:
        limits:
          # Limit memory usage to 4GB
          memory: 4G

    environment:
      SPRING_PROFILES_ACTIVE: "prod"
      #Jvm settings
      JAVA_TOOL_OPTIONS: --enable-native-access=ALL-UNNAMED
        -Dsun.jnu.encoding=UTF-8
        -Dfile.encoding=UTF-8
        -Dai.gebo.neo4j.enabled=true       
        -XX:+AggressiveHeap
        -XX:+PrintGCDetails
        -Xlog:gc:/opt/gebo.ai/logs/gc.log
        -Xms2g
        -Xmx4g
        -XX:MaxMetaspaceSize=512m
        --add-opens=java.base/java.nio.charset=ALL-UNNAMED
